#!/usr/bin/env node
/**
 * Approval Workflow Hook - Enforces human approval for publish actions
 *
 * Fires: Before publish/send/launch tool calls
 * Purpose: Create approval request and notify user before sensitive actions
 *
 * Exit Codes:
 *   0 - Success (allows continuation with notification)
 *   2 - Blocked (requires approval - not implemented as hard block)
 *
 * Note: This hook notifies about approval needs but doesn't hard-block.
 * True blocking would require persistent state management.
 */

const fs = require('fs');
const path = require('path');

// Approval requests directory
const APPROVALS_DIR = 'plans/approvals';

// Actions requiring approval
const APPROVAL_REQUIRED_ACTIONS = [
  'publish',
  'send_email',
  'launch_campaign',
  'post_social',
  'go_live',
  'deploy',
  'activate_ads'
];

// Tool patterns that require approval
const APPROVAL_TOOL_PATTERNS = [
  /publish/i,
  /send.*email/i,
  /launch/i,
  /post.*social/i,
  /deploy/i,
  /activate/i
];

/**
 * Ensure approvals directory exists
 * @returns {string} Path to approvals directory
 */
function ensureApprovalsDir() {
  if (!fs.existsSync(APPROVALS_DIR)) {
    fs.mkdirSync(APPROVALS_DIR, { recursive: true });
  }
  return APPROVALS_DIR;
}

/**
 * Check if action requires approval
 * @param {Object} payload - Hook payload
 * @returns {boolean} Whether approval is required
 */
function requiresApproval(payload) {
  const toolName = (payload.tool_name || '').toLowerCase();
  const taskDesc = (payload.task_description || payload.prompt || '').toLowerCase();

  // Check explicit action names
  for (const action of APPROVAL_REQUIRED_ACTIONS) {
    if (toolName.includes(action) || taskDesc.includes(action)) {
      return true;
    }
  }

  // Check tool patterns
  for (const pattern of APPROVAL_TOOL_PATTERNS) {
    if (pattern.test(toolName) || pattern.test(taskDesc)) {
      return true;
    }
  }

  return false;
}

/**
 * Generate approval request filename
 * @param {string} actionType - Type of action
 * @returns {string} Filename
 */
function generateApprovalFilename(actionType) {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const sanitizedAction = actionType.replace(/[^a-z0-9-]/gi, '-');
  return `${timestamp}-${sanitizedAction}.md`;
}

/**
 * Extract content preview from payload
 * @param {Object} payload - Hook payload
 * @returns {string} Content preview
 */
function extractContentPreview(payload) {
  const sources = [
    payload.task_description,
    payload.prompt,
    payload.content,
    payload.input?.content
  ];

  for (const source of sources) {
    if (source && typeof source === 'string') {
      return source.substring(0, 500);
    }
  }

  return 'No content preview available';
}

/**
 * Create approval request document
 * @param {Object} payload - Hook payload
 * @param {string} actionType - Type of action
 * @returns {string} Markdown content for approval request
 */
function createApprovalRequest(payload, actionType) {
  const contentPreview = extractContentPreview(payload);
  const timestamp = new Date().toISOString();

  return `# Approval Request

## Details

| Field | Value |
|-------|-------|
| **Action** | ${actionType} |
| **Agent** | ${payload.agent_type || 'unknown'} |
| **Requested** | ${timestamp} |
| **Session** | ${payload.session_id || 'unknown'} |

## Content Preview

\`\`\`
${contentPreview}${contentPreview.length >= 500 ? '...' : ''}
\`\`\`

## Approval Status

- [ ] **Approved** - Proceed with action
- [ ] **Rejected** - Do not proceed
- [ ] **Needs Revision** - Requires changes before approval

## Reviewer Notes

<!-- Add your notes here -->

---

## Instructions

1. Review the content above
2. Check the appropriate status checkbox
3. Add any notes or required changes
4. Save this file
5. Inform the agent of your decision

## Auto-Generated

This approval request was automatically generated by the approval-workflow hook.
`;
}

/**
 * Determine action type from payload
 * @param {Object} payload - Hook payload
 * @returns {string} Action type
 */
function determineActionType(payload) {
  const toolName = (payload.tool_name || '').toLowerCase();
  const taskDesc = (payload.task_description || '').toLowerCase();

  for (const action of APPROVAL_REQUIRED_ACTIONS) {
    if (toolName.includes(action) || taskDesc.includes(action)) {
      return action;
    }
  }

  return 'action';
}

/**
 * Main hook execution
 */
async function main() {
  try {
    const stdin = fs.readFileSync(0, 'utf-8').trim();
    if (!stdin) process.exit(0);

    const payload = JSON.parse(stdin);

    // Check if this action requires approval
    if (!requiresApproval(payload)) {
      process.exit(0);
    }

    // Ensure approvals directory exists
    const approvalsDir = ensureApprovalsDir();

    // Determine action type
    const actionType = determineActionType(payload);

    // Generate approval request
    const filename = generateApprovalFilename(actionType);
    const approvalPath = path.join(approvalsDir, filename);
    const approvalContent = createApprovalRequest(payload, actionType);

    // Write approval request
    fs.writeFileSync(approvalPath, approvalContent, 'utf8');

    // Build notification for agent context
    const contextLines = [
      `## Approval Required`,
      ``,
      `**Action:** ${actionType}`,
      `**Approval Request:** ${approvalPath}`,
      ``,
      `### Important`,
      `This action requires human approval before proceeding.`,
      ``,
      `**Next Steps:**`,
      `1. Review the approval request at: ${approvalPath}`,
      `2. Wait for user to mark as approved`,
      `3. Only proceed when explicitly approved`,
      ``,
      `> Do not proceed with ${actionType} without explicit approval.`
    ];

    // Output for SubagentStart hook format
    const output = {
      hookSpecificOutput: {
        hookEventName: 'SubagentStart',
        additionalContext: contextLines.join('\n')
      }
    };

    console.log(JSON.stringify(output));
    process.exit(0);
  } catch (error) {
    // Fail silently - don't block execution
    process.exit(0);
  }
}

main();

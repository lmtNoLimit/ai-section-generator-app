RESEARCH SUMMARY - Billing Bugs & Subscription Tracking Prevention
================================================================

Report: researcher-02-billing-bugs-prevention.md
Lines: 191 | Format: Concise, structured tables & actionable fixes

KEY FINDINGS:
=============

1. COMMON BILLING BUGS (6 critical issues)
   - Duplicate charges via retry storms + network timeouts
   - Usage meter event loss/duplication (especially AI-specific)
   - Reconciliation gaps (usage billed separately, manual Excel re-entry)
   - Unpredictable bills driving customer anxiety & chargebacks
   - Case-sensitivity status bugs
   - Cycle reset bugs causing double-counting

2. PAID USER TRACKING CORRECTNESS
   - Pre-check + post-log pattern (verify quota before, record after)
   - Immutable record creation (pending → accepted flow)
   - Graceful degradation (local fallback if Shopify API fails)
   - Billing cycle anchoring using Shopify's currentPeriodEnd
   - Event normalization (1 generation = 1 record)

3. IDEMPOTENT CHARGE PATTERNS
   - Unique idempotencyKey format: ${shop}-${sectionId}-${timestamp}
   - Server checks key before processing; returns cached result if exists
   - Cache duration: 24-48 hours
   - Current app: Already has idempotencyKey with unique index
   - Gap: No attempt counter (retry storms could reuse same key)

4. FAILED CHARGE RECOVERY
   - Shopify's approach: Auto-retry on next billing period (deferred)
   - Industry best practices: ML-driven retry timing (56% recovery avg)
   - Recommended: Daily retry job (max 3 attempts, 24h+ apart)
   - Passive approach: Let Shopify handle, app tracks in FailedUsageCharge
   - Customer comms: Email when charge approaches cap

5. AUDIT LOGGING FOR DISPUTES
   - What to log: timestamp, action, actor, resource, before/after state, error
   - Immutable storage: Append-only, no delete/update
   - Retention: 8 years minimum (India Rule 11(g), GDPR/SOX compliance)
   - Dispute evidence: Export audit trail showing merchant approval + charge proof
   - Chargeback prevention: Clear T&S, dynamic billing descriptor, pre-renewal alerts

PRIORITY FIXES (Ranked):
=======================

HIGH (Week 1):
  1. Immutable BillingAuditLog table + logging service
  2. Idempotency key hardening (add attempt counter)

MEDIUM (Week 2):
  3. Failed charge recovery job (daily retries)
  4. Pre-renewal email (7 days before charge)

LOW (Week 3+):
  5. Billing reconciliation service (weekly Shopify sync)

CURRENT APP STATUS:
===================
✓ Idempotency keys implemented (UsageRecord.idempotencyKey)
✓ Graceful degradation (error → local increment)
✓ FailedUsageCharge table exists
⚠ NO audit logging table (gap)
⚠ NO retry job for failed charges (gap)
⚠ NO pre-renewal notifications (gap)

SOURCES CITED:
==============
- Paid.ai, Orb, Stripe, Airbnb Engineering, API Dog, Justt, AuditBoard, HubiFi
- Industry standards: Usage-based billing, idempotency, audit trails, chargeback prevention

